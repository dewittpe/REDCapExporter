---
title: "REDCap ExporteR"
author: "Peter DeWitt"
date: "`r Sys.Date()`"
output:
 rmarkdown::html_vignette:
   toc: true
   number_sections: true
vignette: >
 %\VignetteIndexEntry{export}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---


```{r label = "setup", include = FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```


The purpose of this vignette is to show how to export a REDCap project into a
R data package.  There are some prerequisites, described in detail in the
first section, you will need to address before running the examples.


# Prerequisites and Tokens

You will need to have API Export rights for the REDCap project you are
looking to export into an R data package.  Contact the project owner, system
admin, or go through your institution's REDCap page to acquire an API token.

Remember, your API token is the equivalent of a username/password
combination.  Thus, you must treat the token with the same, or more, level of
security you would treat any username/password combination.  **DO NOT PUT THE
TOKEN IN PLAIN TEXT!**

There are many ways to deal with tokens.  One option would be two require the
end user to enter the key interactively via
[getPass](https://cran.r-project.org/package=getPass), e.g.,


```{r label = "getPass"}
# a_token <- getPass::getPass()
```


However, there are at least two issues with this approach:

1. It is interactive and cannot be scripted.
2. Storing the token in an object would make it
possible to divulge the token, either accidentally or via malicious intent.

A better way to handle API tokens is to use the
[secret](https://cran.r-project.org/package=secret).  We encourage the reader
to read the "secrets" vignette.
`vignette(topic = "secrets", package = "secret")`

We suggest the reader set up a vault with their API token as a secret.
Accessing the secret in scripts can be done non-interactively and will a
lower chance of accidental or malicious divulging of a token.

For the rest of this vignette we will use `secret::get_secret()` to assess a
REDCap API token.

## Namespaces, Options, and System Environment Variables

For this example we will load and attach the following namespaces and set
several options and system environment variables.


```{r label = "namespacesAndOptions"}
library(REDCapExporteR)
library(data.table)
library(magrittr)
library(secret)
library(qwraps2)

options("datatable.print.topn"  = 3)
options("datatable.print.nrows" = 6)

# private key needed to access the vault
Sys.setenv(USER_KEY = "~/.ssh/vaults")

# REDCap API uri and token
Sys.setenv(REDCap_API_uri = "https://redcap.ucdenver.edu/api/")
Sys.setenv(REDCap_API_TOKEN = get_secret("2000_2001_Avalanche"))

# Set the option the format the data will be returned in.  Possible values are
# 'csv', 'xml', or 'json'. The default is 'csv', set when
# qwraps2::Rpkg(REDCapExporteR) is loaded.
Sys.getenv("REDCap_API_format")
```




# Exporting a REDCap Project

The primary objective of the `r qwraps2::Rpkg(REDCapExporteR)` is to export
all the data from an REDCap project via the REDCap API and build a R data
package with useful documentation and tools.  The data package will make it
easy to archive data and distribute data, in an analysis ready format, within
a group of analysts.

**Disclaimer and Warning:** It is the responsibility of the end user to
protect sensitive data.  Do not use `r qwraps2::Rpkg(REDCapExporteR)` to
export data onto a computer that should not have sensitive data stored on it.
Further, do not distribute the resulting R package to any other machine or
person who does not have data access rights.

For the example in this vignette we created a REDCap project storing the
roster and statistics for the 2000-2001 Stanley Cup Champion Colorado
Avalanche of the National Hockey League.  The data was acquired from the
web page
[Hockey Reference](https://www.hockey-reference.com/teams/COL/2001.html).


## Specific Export Methods

The methods presented here are for one offs.  There are more generic
functions for exporting the whole REDCap project.

The `r qwraps2::Rpkg(REDCapExporteR)` method `export_content` can be used to
export specific parts of a REDCap project. Three of the arguments, `uri`,
`token`, and `format`, passed to
`export_content`, if omitted, will default to the system environment
variables.  Thus, only the `content` argument must be defined by the user.
Additional arguments for the API are passed via the `...`.  Check your
specific REDCap API documentation.


```{r }
str(export_content)
```


For example, the project information and project metadata can be exported
via:

```{r }
project_info <- export_content(content = "project")
metadata     <- export_content(content = "metadata")
```


The return object from `export_content` are character strings as you would
expect from a call to `postForm` from the
[`r qwraps2::Rpkg(RCurl)`](https://cran.r-project.org/package=RCurl) package.
A couple additional attributes have been added.  The `Sys.time` for the call
and the class `rcer_*` where `*` is replaced by the value of the `content`
argument.

We opted to have `export_content` return a character string such that the end
user can may select the format for the return and use the tool of their
choice for creating a `data.frame`.  For example, creating a `data.table`
from the csv or json formats.

```{r }
from_csv <- data.table::fread(input = metadata, colClasses = "character")

from_json <-
  export_content(content = "metadata", format = "json") %>%
  rjson::fromJSON(json_str = .) %>%
  lapply(as.data.table) %>%
  rbindlist

identical(from_csv, from_json)
```




## Data Import Tools

When working with REDCap data it is likely that you will have more collumns
than you would want to have to code a data import method for yourself.  This
is especially true if you need to deal with columns that may look like
numeric values but are really categorical.  We provide some tools to help
with the data import process.

First, you will need to get the project metadata.

```{r }
avs_raw_metadata <- export_content(content = "metadata")
str(avs_raw_metadata)
```


There are `as.data.frame` and `as.data.table` methods for getting the
metadata into a useful format.

```{r }
avs_metadata <- as.data.table(avs_raw_metadata)
str(avs_metadata)
```


The function `col_type` will take the metadata and return ...

```{r }
col_type(avs_metadata)

# avs_records  <- export_content(content = "record")
```





# Session Info


```{r }
print(sessionInfo(), local = FALSE)
#
```

